define(["sulusalesorder/util/sidebar","sulusalesorder/util/orderStatus","sulusalesorder/util/header","sulusalescore/util/helper","sulucontact/models/account","sulucontact/models/contact","config","widget-groups"],function(a,b,c,d,e,f,g,h){"use strict";var i="#order-form",j={currencyCode:g.get("sulu_sales_core").default_currency},k="sulu.salesorder.",l=k+"set-options-data",m={ORGANIZATION:1,PRIVAT_PERSON:2},n={accountContactsUrl:"/admin/api/accounts/<%= id %>/contacts?flat=true",accountAddressesUrl:"/admin/api/accounts/<%= id %>/addresses",customerAccountId:"customer-account",customerAccountSelector:"#customer-account",customerContactId:"customer-contact",customerContactSelector:"#customer-contact",customerAutocompleteContainer:"#customer-autocomplete-container",deliveryAddressInstanceName:"delivery-address",billingAddressInstanceName:"billing-address",currencySelectInstanceName:"currency-select",currencySelectSelector:"#currency-select",customerTypeSelectInstanceName:"customer-type-select",itemTableInstanceName:"order-items",itemTableSelector:"#order-items",paymentTermsInstanceName:"payment-terms",deliveryTermsInstanceName:"delivery-terms",contactSelectInstanceName:"contact-select",validateWarningTranslation:"form.validation-warning",translationShippingFailed:"salescore.shipping-failed",autocompleteLimit:20},o=function(){return this.options.data&&this.options.data.status?this.options.data.status.id:null},p=function(a,b){this.options[a]=b},q=function(){this.sandbox.on(l,p.bind(this)),this.sandbox.on("husky.auto-complete."+this.customerAccountInstanceName+".initialized",function(){this.isEditable||this.sandbox.dom.attr(this.$find(n.customerAccountSelector+" input"),"disabled","disabled"),this.dfdAutoCompleteInitialized.resolve()},this),this.sandbox.on("husky.auto-complete."+this.customerAccountInstanceName+".select",G.bind(this)),this.sandbox.on("husky.auto-complete."+this.customerAccountInstanceName+".selection-removed",G.bind(this)),this.sandbox.on("husky.auto-complete."+this.customerContactInstanceName+".initialized",function(){this.isEditable||this.sandbox.dom.attr(this.$find(n.customerContactSelector+" input"),"disabled","disabled"),this.dfdAutoCompleteInitialized.resolve()},this),this.sandbox.on("husky.auto-complete."+this.customerContactInstanceName+".select",H.bind(this)),this.sandbox.on("husky.auto-complete."+this.customerContactInstanceName+".selection-removed",H.bind(this)),this.sandbox.on("sulu.salesorder.order.saved",function(a){this.options.data=a,t.call(this,!0),this.dfdFormSaved.resolve()},this),this.sandbox.on("sulu.toolbar.save",function(){this.submit()},this),this.sandbox.on("sulu.header.back",function(){this.sandbox.emit("sulu.salesorder.orders.list")},this),this.sandbox.on("husky.input.shipping-date.initialized",function(){this.dfdShippingDate.resolve()},this),this.sandbox.on("husky.input.order-date.initialized",function(){this.dfdOrderDate.resolve()},this),this.sandbox.on("sulu.editable-data-row."+n.deliveryAddressInstanceName+".initialized",function(){this.dfdDeliveryAddressInitialized.resolve()}.bind(this)),this.sandbox.on("sulu.editable-data-row."+n.billingAddressInstanceName+".initialized",function(){this.dfdInvoiceAddressInitialized.resolve()}.bind(this)),this.sandbox.on("sulu.editable-data-row.address-view."+n.deliveryAddressInstanceName+".changed",function(a){this.options.data.deliveryAddress=a,v.call(this,this.options.data),J.call(this)}.bind(this)),this.sandbox.on("sulu.editable-data-row.address-view."+n.billingAddressInstanceName+".changed",function(a){this.options.data.invoiceAddress=a,v.call(this,this.options.data),J.call(this)}.bind(this)),this.sandbox.on("husky.select."+n.currencySelectInstanceName+".selected.item",function(a){this.sandbox.emit("sulu.item-table."+n.itemTableInstanceName+".change-currency",a),this.currency=a},this),this.sandbox.on("sulu.salesorder.set-customer-id",function(a){this.customerId=a},this),this.sandbox.on("husky.select."+n.contactSelectInstanceName+".initialize",function(){this.dfdContactInitialized.resolve()},this),this.sandbox.on("husky.select."+n.customerTypeSelectInstanceName+".initialize",function(){this.dfdCustomerTypeInitialized.resolve()},this),this.sandbox.on("husky.select."+n.customerTypeSelectInstanceName+".selected.item",function(a){a=parseInt(a),this.customerTypeId!=a&&I.call(this,a)},this)},r=function(){this.sandbox.dom.on(this.$el,"click",s.bind(this),"#tax-free")},s=function(a){var b=$(a.currentTarget).is(":checked");this.sandbox.emit("sulu.item-table."+n.itemTableInstanceName+".update-price",b)},t=function(a){a!==this.saved&&(a?c.disableSave.call(this):c.enableSave.call(this)),this.saved=a},u=function(a){var b=this.sandbox.form.create(i);b.initialized.then(function(){v.call(this,a,!0),w.call(this,a)}.bind(this))},v=function(a){this.sandbox.form.setData(i,a).then(function(){this.accountId=z.call(this),this.contactId=A.call(this)}.bind(this)).fail(function(a){this.sandbox.logger.error("An error occured when setting data!",a)}.bind(this))},w=function(a){return this.sandbox.start(i),a&&!a.customerAccount&&a.customerContact&&a.customerContact.id?void y.call(this,a):void x.call(this,a)},x=function(a){this.sandbox.stop(n.customerContactSelector);var b=this.sandbox.dom.createElement('<div id="'+n.customerAccountId+'"/>');this.sandbox.dom.append($.find(n.customerAutocompleteContainer),b);var c=g.get("sulucontact.components.autocomplete.default.account");c.el=n.customerAccountSelector,c.value=a&&a.customerAccount?a.customerAccount:"",c.instanceName=this.customerAccountInstanceName,c.remoteUrl+="&type="+this.customerId+"&limit="+n.autocompleteLimit,c.limit=n.autocompleteLimit,this.sandbox.start([{name:"auto-complete@husky",options:c}]),a&&a.customerAccount&&a.customerAccount.id&&L.call(this,a.customerAccount.id,a)},y=function(a){this.sandbox.stop(n.customerAccountSelector);var b=this.sandbox.dom.createElement('<div id="'+n.customerContactId+'"/>');this.sandbox.dom.append($.find(n.customerAutocompleteContainer),b);var c=g.get("sulucontact.components.autocomplete.default.contact");c.el=n.customerContactSelector,c.value=a&&a.customerContact?a.customerContact:"",c.instanceName=this.customerContactInstanceName,c.limit=n.autocompleteLimit,this.sandbox.start([{name:"auto-complete@husky",options:c}]),a&&a.customerContact&&a.customerContact.id&&K.call(this,a.customerContact,a)},z=function(){return this.sandbox.dom.attr(n.customerAccountSelector,"data-id")},A=function(){return this.sandbox.dom.attr(n.customerContactSelector,"data-id")},B=function(a){this.customerTypeId=a,this.sandbox.data.when(this.dfdCustomerTypeInitialized).then(function(){this.sandbox.emit("husky.select.customer-type-select.update",this.options.customerTypes,[a])}.bind(this))},C=function(a,b){b=b||[],this.sandbox.data.when(this.dfdContactInitialized).then(function(){this.sandbox.emit("husky.select.contact-select.update",a,b)}.bind(this))},D=function(a,b,c){this.sandbox.emit("sulu.editable-data-row."+b+".data.update",a,c),this.$find("#"+n.deliveryAddressInstanceName).removeClass("disabled-button"),this.$find("#"+n.billingAddressInstanceName).removeClass("disabled-button")},E=function(a,b){this.sandbox.emit("sulu.editable-data-row."+a+".set-value",b)},F=function(a,b){this.sandbox.emit("sulu.item-table."+n.itemTableInstanceName+".set-addresses",a,b)},G=function(a){var b=a&&a.id?a.id:null;b!==this.accountId&&(this.accountId=b,b?L.call(this,b):(C.call(this,[]),D.call(this,[],n.deliveryAddressInstanceName),D.call(this,[],n.billingAddressInstanceName),F.call(this,[])))},H=function(a){var b=a&&a.id?a.id:null;b!==this.contactId&&(this.contactId=b,b?K.call(this,a):(C.call(this,[]),D.call(this,[],n.deliveryAddressInstanceName),D.call(this,[],n.billingAddressInstanceName),F.call(this,[])))},I=function(a){switch(this.customerTypeId=a,a){case m.ORGANIZATION:x.call(this),G.call(this,null);break;case m.PRIVAT_PERSON:y.call(this),H.call(this,null)}},J=function(){t.call(this,!1)},K=function(a,b){var c=null,d=null,e=f.findOrCreate({id:a.id});e.fetch({success:function(a){var c=a.toJSON();if(c.hasOwnProperty("addresses")){var e=c.addresses;d=null,b&&b.deliveryAddress?d=b.deliveryAddress:(d=N.call(this,e,"deliveryAddress",!0),!d&&e.length>0&&(d=e[0])),this.sandbox.data.when(this.dfdDeliveryAddressInitialized).then(function(){D.call(this,e,n.deliveryAddressInstanceName,d),F.call(this,e,d),this.options.data.deliveryAddress=d}.bind(this)),d=null,b&&b.invoiceAddress?d=b.invoiceAddress:(d=N.call(this,e,"billingAddress",!0),!d&&e.length>0&&(d=e[0])),this.sandbox.data.when(this.dfdInvoiceAddressInitialized).then(function(){D.call(this,e,n.billingAddressInstanceName,d),this.options.data.invoiceAddress=d}.bind(this))}}.bind(this),error:function(){this.sandbox.emit("sulu.labels.warning.show",this.sandbox.translate("error while fetching account"))}.bind(this)}),a&&a.id&&(c=[a],d=[a.id],C.call(this,c,d)),B.call(this,m.PRIVAT_PERSON)},L=function(a,b){var c,d,f,g;f=e.findOrCreate({id:a}),f.fetch({success:function(a){f=a.toJSON();var c=null,e=null;b||(f.hasOwnProperty("termsOfDelivery")&&f.termsOfDelivery&&(e=f.termsOfDelivery.terms),E.call(this,n.deliveryTermsInstanceName,e),f.hasOwnProperty("termsOfPayment")&&f.termsOfPayment&&(c=f.termsOfPayment.terms),E.call(this,n.paymentTermsInstanceName,c)),f.hasOwnProperty("addresses")&&(g=f.addresses,d=null,b&&b.deliveryAddress?d=b.deliveryAddress:(d=N.call(this,g,"deliveryAddress",!0),!d&&g.length>0&&(d=g[0])),this.sandbox.data.when(this.dfdDeliveryAddressInitialized).then(function(){D.call(this,g,n.deliveryAddressInstanceName,d),F.call(this,g,d),this.options.data.deliveryAddress=d}.bind(this)),d=null,b&&b.invoiceAddress?d=b.invoiceAddress:(d=N.call(this,g,"billingAddress",!0),!d&&g.length>0&&(d=g[0])),this.sandbox.data.when(this.dfdInvoiceAddressInitialized).then(function(){D.call(this,g,n.billingAddressInstanceName,d),this.options.data.invoiceAddress=d}.bind(this)))}.bind(this),error:function(){this.sandbox.emit("sulu.labels.warning.show",this.sandbox.translate("error while fetching account"))}.bind(this)}),this.sandbox.util.load(this.sandbox.util.template(n.accountContactsUrl,{id:a})).then(function(a){c=a._embedded.contacts,d=b&&b.customerContact?[b.customerContact.id]:null,C.call(this,c,d)}.bind(this)).fail(function(a,b){this.sandbox.logger.error(a,b)}.bind(this)),B.call(this,m.ORGANIZATION)},M=function(a,b){var c=[];return this.sandbox.util.each(b,function(d){return b[d].code===a?(c.push(b[d].id),!1):void 0}.bind(this)),c},N=function(a,b,c){var d=null;return a&&a.length>0&&this.sandbox.util.each(a,function(a,e){return e.hasOwnProperty(b)&&e[b]===c?(d=e,!1):void 0}.bind(this)),d};return{view:!0,layout:{content:{width:"fixed"},sidebar:{width:"max",cssClasses:"sidebar-padding-50"}},templates:["/admin/order/template/order/form"],initialize:function(){this.saved=!0,this.formId=i,this.accountId=null,this.contactId=null,this.customerTypeId=null,this.dfdFormSaved=this.sandbox.data.deferred(),this.dfdAllFieldsInitialized=this.sandbox.data.deferred(),this.dfdAutoCompleteInitialized=this.sandbox.data.deferred(),this.dfdShippingDate=this.sandbox.data.deferred(),this.dfdOrderDate=this.sandbox.data.deferred(),this.dfdContactInitialized=this.sandbox.data.deferred(),this.dfdCustomerTypeInitialized=this.sandbox.data.deferred(),this.dfdInvoiceAddressInitialized=this.sandbox.data.deferred(),this.dfdDeliveryAddressInitialized=this.sandbox.data.deferred(),this.sandbox.data.when(this.dfdShippingDate,this.dfdOrderDate,this.dfdAutoCompleteInitialized).then(function(){this.dfdAllFieldsInitialized.resolve()}.bind(this)),this.orderStatusId=o.call(this),this.isEditable=this.orderStatusId<=b.IN_CART,this.options.data=this.sandbox.util.extend({},j,this.options.data);var d=this.options.data.id?this.options.data.id:"new";this.customerAccountInstanceName="customerAccount"+d,this.customerContactInstanceName="customerContact"+d,q.call(this),r.call(this),c.initialize.call(this),t.call(this,!0),this.render(),c.setToolbar.call(this,this.options.data),this.listenForChange(),this.options.data&&this.options.data.id&&h.exists("order-detail")&&a.initForDetail(this.sandbox,this.options.data)},render:function(){this.sandbox.dom.html(this.$el,this.renderTemplate(this.templates[0],{isEditable:this.isEditable,parseDate:d.parseDate}));var a=this.options.data;u.call(this,a),this.startItemTableAndCurrencySelect()},startItemTableAndCurrencySelect:function(){this.sandbox.start([{name:"item-table@sulusalescore",options:{instanceName:n.itemTableInstanceName,isEditable:this.isEditable,remoteUrl:n.accountUrl,data:this.options.data.items,currency:this.options.data.currencyCode,el:n.itemTableSelector,enableIndependentItems:!0,settings:{columns:["addresses","description","quantity","single-price","delivery-date","cost-center","discount","tax-rate"],taxClasses:this.options.taxClasses,units:this.options.units},taxfree:this.options.data.taxfree,deliveryCost:this.options.data.deliveryCost,enableDeliveryCost:!0,deliveryCostChangedCallback:function(a){this.deliveryCost=a}.bind(this)}},{name:"select@husky",options:{el:n.currencySelectSelector,instanceName:n.currencySelectInstanceName,disabled:!this.isEditable,emitValues:!0,defaultLabel:this.sandbox.translate("dropdown.please-choose"),multipleSelect:!1,repeatSelect:!1,valueName:"code",data:this.options.currencies,preSelectedElements:M.call(this,this.options.data.currencyCode,this.options.currencies)}}])},submit:function(){if(this.dfdFormSaved=this.sandbox.data.deferred(),this.sandbox.logger.log("save Model"),this.sandbox.form.validate(i)){var a=this.sandbox.form.getData(i);""===a.id&&delete a.id,a.currencyCode=this.currency?this.currency:this.options.data.currencyCode,a.deliveryCost=this.deliveryCost,a.customerAccount={id:this.sandbox.dom.attr("#"+this.customerAccountInstanceName,"data-id")},this.sandbox.logger.log("log data",a),this.sandbox.emit("sulu.salesorder.order.save",a)}else this.sandbox.emit("sulu.labels.warning.show",this.sandbox.translate(n.validateWarningTranslation)),this.dfdFormSaved.reject();return this.dfdFormSaved},listenForChange:function(){this.sandbox.data.when(this.dfdAllFieldsInitialized).then(function(){this.sandbox.dom.on(i,"change",J.bind(this),".changeListener select, .changeListener input, .changeListener .pickdate, .changeListener .husky-select, .changeListener textarea"),this.sandbox.dom.on(i,"keyup",J.bind(this),".changeListener select, .changeListener input, .changeListener textarea"),this.sandbox.on("sulu.item-table.changed",J.bind(this))}.bind(this))}}});