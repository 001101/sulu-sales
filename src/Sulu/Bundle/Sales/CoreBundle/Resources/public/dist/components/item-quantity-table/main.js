define(["text!sulusalescore/components/item-quantity-table/item.form.html","text!sulusalescore/components/item-quantity-table/item.row.html","text!sulusalescore/components/item-quantity-table/item.row-head.html","config"],function(a,b,c,d){"use strict";var e={data:[],itemsData:[],processedQuantityValueName:"shippedItems",processedItems:null,canAddRemove:!1,showFinishedItems:!0,isEditable:!0,isNew:!1,headerTranslations:{}},f={formId:"#item-table-form",listClass:".item-table-list",productSearchClass:".product-search",rowIdPrefix:"item-table-row-",rowClass:".item-table-row",quantityRowClass:".item-quantity",quantityInput:".quantity-input input"},g={rowClass:null,rowNumber:null,rowId:"",id:null,item:{id:null,name:"",number:"",quantity:"",quantityUnit:"",price:"",discount:null,overallPrice:"",currency:d.get("sulu_sales_core").default_currency,useProductsPrice:!1,tax:0},processedQuantity:null,quantity:null},h="sulu.item-table.",i=h+"changed",j=function(){var a,b,c={},d={rowClass:"header",name:this.sandbox.translate("salescore.item.product"),number:this.sandbox.translate("salescore.item.number"),quantity:this.sandbox.translate("salescore.item.order-quantity"),quantityInput:this.sandbox.translate("salescore.item.quantity"),quantityUnit:this.sandbox.translate("salescore.item.unit"),price:this.sandbox.translate("salescore.item.price"),discount:this.sandbox.translate("salescore.item.discount"),overallPrice:this.sandbox.translate("salescore.item.overall-value"),processedQuantity:this.sandbox.translate("salescore.item.processed-quantity")};for(a in this.options.headerTranslations)this.options.headerTranslations.hasOwnProperty(a)&&(c[a]=this.sandbox.translate(this.options.headerTranslations[a]));return b=this.sandbox.util.extend({},d,c)},k=function(){},l=function(){this.sandbox.dom.on(this.$el,"data-changed",function(a){var b=a.items||[];q.call(this,b)}.bind(this)),this.sandbox.dom.on(this.$el,"change",m.bind(this),f.quantityInput)},m=function(a){var b=n.call(this,a).id;this.items[b].quantity=this.sandbox.dom.val(a.target),t.call(this),this.sandbox.emit(i)},n=function(a){var b=this.sandbox.dom.closest(a.target,".item-table-row"),c=this.sandbox.dom.attr(b,"id");return{row:b,id:c}},o=function(a,c){var d,e,h,i=0;return c!==!1&&this.rowCount++,this.options.processedItems?(h=a.item.id,i=this.options.processedItems[h]||0):a.hasOwnProperty(this.options.processedQuantityValueName)&&(i=a[this.options.processedQuantityValueName]),!this.options.showFinishedItems&&0===a.quantity&&a.quantity-i<1?void 0:(d=this.sandbox.util.extend({},g,a,{rowId:f.rowIdPrefix+this.rowCount,rowNumber:this.rowCount,isEditable:this.options.isEditable,isNew:this.options.isNew,canAddRemove:this.options.canAddRemove,processedQuantity:i,numberFormat:this.sandbox.numberFormat}),d.maxQuantity=(parseFloat(d.item.quantity)-parseFloat(i)).toFixed(1),d.maxQuantity=d.maxQuantity%1===0?parseInt(d.maxQuantity):d.maxQuantity,d.formattedMaxQuantity=this.sandbox.numberFormat(d.maxQuantity,"d"),d.isNew&&(d.quantity=d.formattedMaxQuantity),e=this.sandbox.util.template(b,d),this.sandbox.dom.createElement(e))},p=function(a){var b=o.call(this,a);return this.sandbox.dom.append(this.$find(f.listClass),b),b},q=function(a){this.items={},this.sandbox.dom.empty(this.$find(f.listClass)),r.call(this,a)},r=function(a){var b,c,d,e,g,h;for(b=-1,c=a.length;++b<c;)d=a[b],e=p.call(this,d),g=this.sandbox.dom.attr(e,"id"),this.options.isNew&&(h=this.sandbox.dom.val(this.sandbox.dom.find(f.quantityInput,e)),d.quantity=h),this.items[g]=d;t.call(this)},s=function(){var a=this.sandbox.util.extend({canAddRemove:this.options.canAddRemove},g,j.call(this)),b=this.sandbox.util.template(c,a);this.sandbox.dom.append(this.$find(f.listClass),b)},t=function(){this.sandbox.dom.data(this.$el,"items",this.getItems())},u=function(a){var b,c;for(b in this.options.data)if(this.options.data.hasOwnProperty(b)&&(c=this.options.data[b].item,c.id===a))return this.options.data[b];return null},v=function(){var a,b,c,d=[];for(a in this.options.itemsData)this.options.itemsData.hasOwnProperty(a)&&(c=this.options.itemsData[a],b=u.call(this,c.id),b||(b=this.sandbox.util.extend({},g,{item:c})),d.push(b));return this.options.data=d,d},w=function(){this.sandbox.form.create(f.formId)};return{initialize:function(){var a;this.options=this.sandbox.util.extend({},e,this.options),this.items={},this.rowCount=0,this.table=null,this.isEmpty=this.items.length,a=this.sandbox.dom.data(this.$el,"items"),0===this.options.data.length&&a&&a.length>0&&(this.options.data=a),v.call(this),this.render(),k.call(this),l.call(this),t.call(this)},render:function(){var b=this.sandbox.util.extend({},{addText:this.sandbox.translate("salescore.item.add"),isEditable:this.options.isEditable,canAddRemove:this.options.canAddRemove},this.options.data);this.table=this.sandbox.util.template(a,b),this.html(this.table),s.call(this),r.call(this,this.options.data),w.call(this)},getItems:function(){var a,b=[];for(a in this.items)this.items.hasOwnProperty(a)&&b.push(this.items[a]);return b}}});